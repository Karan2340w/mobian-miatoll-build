name: Build Mobian Miatoll

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y debos git libglib2.0-dev libostree-dev qemu-system-x86 qemu-user-static debootstrap libyaml-dev binfmt-support systemd-container wget unzip

      # THE CRITICAL FIX: SILENT WRAPPER
      # We replace the real 'debos' command with a wrapper that forces the flag.
      # This way, we don't have to pass the flag to build.sh (which causes the crash).
      - name: Setup Debos Wrapper
        run: |
          # Find the real debos
          DEBOS_BIN=$(which debos)
          
          # Rename it
          sudo mv $DEBOS_BIN ${DEBOS_BIN}-original
          
          # Create the wrapper script
          # It silently adds --disable-fakemachine to every command
          echo '#!/bin/bash' | sudo tee $DEBOS_BIN
          echo "${DEBOS_BIN}-original --disable-fakemachine \"\$@\"" | sudo tee -a $DEBOS_BIN
          
          # Make executable
          sudo chmod +x $DEBOS_BIN
          
          # Verify it works (should show help without errors)
          debos --help

      - name: Clone Mobian Recipes
        run: |
          git clone https://salsa.debian.org/Mobian-team/mobian-recipes.git

      - name: Configure Device (Hijack Librem 5)
        run: |
          # Overwrite Librem 5 config with Redmi Note 9 Pro Max settings
          mkdir -p mobian-recipes/devices/librem5
          
          cat <<EOF | sudo tee mobian-recipes/devices/librem5/device.toml
          name = "Xiaomi Redmi Note 9 Pro Max"
          arch = "arm64"
          image_format = "android-sparse"
          kernel_package = "linux-image-6.14.7-sm7125"
          u_boot_package = "u-boot-menu"
          
          [boot]
          cmdline = "console=ttyMSM0,115200 loglevel=7"
          EOF

      - name: Inject Kernel
        run: |
          mkdir -p mobian-recipes/overlays/my-kernel/var/tmp/
          cp kernel.deb mobian-recipes/overlays/my-kernel/var/tmp/
          
          TARGET=$(find mobian-recipes -name "rootfs.yaml" -o -name "common.yaml" | head -n 1)
          
          cat <<EOF | sudo tee -a $TARGET
            - action: overlay
              source: overlays/my-kernel
          
            - action: run
              description: Install Custom Kernel
              chroot: true
              command: dpkg -i /var/tmp/kernel.deb && rm /var/tmp/kernel.deb
          EOF

      - name: Run Build
        working-directory: mobian-recipes
        run: |
          # WE REMOVED THE FLAG HERE.
          # The wrapper (Step 4) handles it internally now.
          sudo ./build.sh -t librem5 -e plasma-mobile

      - name: Upload Image
        uses: actions/upload-artifact@v4
        with:
          name: mobian-miatoll-plasma
          path: |
            mobian-recipes/*.img
            mobian-recipes/*.tar.gz
