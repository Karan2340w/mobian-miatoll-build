name: Build Mobian Miatoll

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # Run on the Host machine (not inside a container yet)

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. THE FIX: Register QEMU on the Host Kernel
      # This allows the machine to run ARM64 (Phone) code without the "Exec format error"
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. PREPARE THE BUILD SCRIPT
      # We create a script on the host that we will later run inside Docker
      - name: Create Build Script
        run: |
          cat <<'EOF' > run_build.sh
          #!/bin/bash
          set -e
          
          # Install Dependencies inside the container
          echo ">>> Installing Build Tools..."
          apt-get update
          apt-get install -y git libglib2.0-dev libostree-dev qemu-system-x86 qemu-user-static debootstrap libyaml-dev binfmt-support wget unzip debos

          # Clone Recipes
          echo ">>> Cloning Mobian Recipes..."
          git clone https://salsa.debian.org/Mobian-team/mobian-recipes.git
          cd mobian-recipes

          # Configure Device (Hijack Librem 5)
          echo ">>> Configuring Device..."
          mkdir -p devices/librem5
          cat <<TOML > devices/librem5/device.toml
          name = "Xiaomi Redmi Note 9 Pro Max"
          arch = "arm64"
          image_format = "android-sparse"
          kernel_package = "linux-image-6.14.7-sm7125"
          u_boot_package = "u-boot-menu"
          
          [boot]
          cmdline = "console=ttyMSM0,115200 loglevel=7"
          TOML

          # Inject Kernel
          echo ">>> Injecting Kernel..."
          mkdir -p overlays/my-kernel/var/tmp/
          cp /workspace/kernel.deb overlays/my-kernel/var/tmp/
          
          # Patch Recipe
          TARGET=$(find . -name "rootfs.yaml" -o -name "common.yaml" | head -n 1)
          cat <<YAML >> $TARGET
            - action: overlay
              source: overlays/my-kernel
          
            - action: run
              description: Install Custom Kernel
              chroot: true
              command: dpkg -i /var/tmp/kernel.deb && rm /var/tmp/kernel.deb
          YAML

          # Apply Wrapper to force --disable-fakemachine
          echo ">>> Applying Fakemachine Bypass..."
          DEBOS_BIN=$(which debos)
          mv $DEBOS_BIN ${DEBOS_BIN}-original
          echo '#!/bin/bash' > $DEBOS_BIN
          echo "${DEBOS_BIN}-original --disable-fakemachine \"\$@\"" >> $DEBOS_BIN
          chmod +x $DEBOS_BIN

          # Run Build
          echo ">>> STARTING BUILD..."
          ./build.sh -t librem5 -e plasma-mobile
          EOF
          
          chmod +x run_build.sh

      # 3. RUN THE BUILD INSIDE DOCKER
      # We mount the current folder to /workspace so it can access your kernel.deb
      - name: Execute Build in Docker
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}:/workspace \
            debian:bookworm \
            /workspace/run_build.sh

      # 4. UPLOAD ARTIFACTS
      - name: Upload Image
        uses: actions/upload-artifact@v4
        with:
          name: mobian-miatoll-plasma
          path: |
            mobian-recipes/*.img
            mobian-recipes/*.tar.gz
